// Prisma Schema for TEDx Ticketing Platform
// Optimized for serverless, high-concurrency ticket sales

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================

model Role {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique @db.VarChar(50)
  description String?  @db.VarChar(255)
  permissions String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("roles")
}

model User {
  id           String    @id @default(uuid()) @db.VarChar(36)
  username     String    @unique @db.VarChar(50)
  email        String?   @unique @db.VarChar(100)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  fullName     String    @map("full_name") @db.VarChar(100)
  phoneNumber  String?   @map("phone_number") @db.VarChar(20)
  roleId       String    @map("role_id") @db.VarChar(36)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  role      Role       @relation(fields: [roleId], references: [id])
  orders    Order[]
  auditLogs AuditLog[]

  @@index([email])
  @@index([roleId])
  @@map("users")
}

// ============================================
// EVENTS
// ============================================

model Event {
  id             String    @id @default(uuid()) @db.VarChar(36)
  name           String    @db.VarChar(200)
  slug           String    @unique @db.VarChar(100)
  description    String?   @db.Text
  venue          String    @db.VarChar(200)
  eventDate      DateTime  @map("event_date")
  doorsOpenTime  DateTime  @map("doors_open_time")
  startTime      DateTime  @map("start_time")
  endTime        DateTime  @map("end_time")
  status         String    @default("DRAFT") @db.VarChar(20)
  maxCapacity    Int       @map("max_capacity")
  availableSeats Int       @map("available_seats")
  bannerImageUrl String?   @map("banner_image_url") @db.VarChar(500)
  thumbnailUrl   String?   @map("thumbnail_url") @db.VarChar(500)
  isPublished    Boolean   @default(false) @map("is_published")
  publishedAt    DateTime? @map("published_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  seatLayouts SeatLayout[]
  seats       Seat[]
  orders      Order[]
  timelines   EventTimeline[]

  @@index([slug])
  @@index([status])
  @@index([eventDate])
  @@map("events")
}

// ============================================
// SEAT MANAGEMENT
// ============================================

model SeatLayout {
  id         String   @id @default(uuid()) @db.VarChar(36)
  eventId    String   @map("event_id") @db.VarChar(36)
  name       String   @db.VarChar(100)
  layoutData String   @default("{}") @map("layout_data") @db.Text
  totalSeats Int      @map("total_seats")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("seat_layouts")
}

model Seat {
  id         String   @id @default(uuid()) @db.VarChar(36)
  eventId    String   @map("event_id") @db.VarChar(36)
  seatNumber String   @map("seat_number") @db.VarChar(20)
  row        String   @db.VarChar(10)
  col        String   @db.VarChar(10)
  section    String   @db.VarChar(50)
  seatType   String   @map("seat_type") @db.VarChar(20)
  price      Decimal  @db.Decimal(10, 2)
  status     String   @default("AVAILABLE") @db.VarChar(20)
  positionX  Int?     @map("position_x")
  positionY  Int?     @map("position_y")
  isDisabled Boolean  @default(false) @map("is_disabled")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  event      Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  seatLock   SeatLock?

  @@unique([eventId, seatNumber])
  @@index([eventId, status])
  @@index([seatType])
  @@map("seats")
}

model SeatLock {
  id        String   @id @default(uuid()) @db.VarChar(36)
  seatId    String   @unique @map("seat_id") @db.VarChar(36)
  eventId   String   @map("event_id") @db.VarChar(36)
  sessionId String   @map("session_id") @db.VarChar(64)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  seat Seat @relation(fields: [seatId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("seat_locks")
}

// ============================================
// ORDERS & PAYMENTS
// ============================================

model Order {
  id                 String    @id @default(uuid()) @db.VarChar(36)
  orderNumber        String    @unique @map("order_number") @db.VarChar(50)
  userId             String?   @map("user_id") @db.VarChar(36)
  eventId            String    @map("event_id") @db.VarChar(36)
  totalAmount        Decimal   @map("total_amount") @db.Decimal(10, 2)
  status             String    @default("PENDING") @db.VarChar(20)
  customerEmail      String    @map("customer_email") @db.VarChar(100)
  customerName       String    @map("customer_name") @db.VarChar(100)
  customerPhone      String?   @map("customer_phone") @db.VarChar(20)
  expiresAt          DateTime? @map("expires_at")
  paidAt             DateTime? @map("paid_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason") @db.Text
  accessTokenHash    String?   @map("access_token_hash") @db.VarChar(64)
  qrCodeUrl          String?   @map("qr_code_url") @db.VarChar(500)
  emailSentAt        DateTime? @map("email_sent_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  event      Event       @relation(fields: [eventId], references: [id])
  orderItems OrderItem[]
  payment    Payment?
  emailLogs  EmailLog[]

  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([orderNumber])
  @@index([customerEmail])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(uuid()) @db.VarChar(36)
  orderId    String   @map("order_id") @db.VarChar(36)
  seatId     String   @map("seat_id") @db.VarChar(36)
  price      Decimal  @db.Decimal(10, 2)
  seatNumber String   @map("seat_number") @db.VarChar(20)
  seatType   String   @map("seat_type") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  seat  Seat  @relation(fields: [seatId], references: [id])

  @@index([orderId])
  @@index([seatId])
  @@map("order_items")
}

model Payment {
  id               String    @id @default(uuid()) @db.VarChar(36)
  orderId          String    @unique @map("order_id") @db.VarChar(36)
  paymentMethod    String    @map("payment_method") @db.VarChar(30)
  amount           Decimal   @db.Decimal(10, 2)
  status           String    @default("PENDING") @db.VarChar(20)
  transactionId    String?   @unique @map("transaction_id") @db.VarChar(100)
  paymentGateway   String?   @map("payment_gateway") @db.VarChar(50)
  paymentSessionId String?   @unique @map("payment_session_id") @db.VarChar(100)
  paymentProof     String?   @map("payment_proof") @db.VarChar(500)
  webhookReceived  Boolean   @default(false) @map("webhook_received")
  webhookProcessed Boolean   @default(false) @map("webhook_processed")
  webhookData      String?   @map("webhook_data") @db.Text
  paidAt           DateTime? @map("paid_at")
  refundedAt       DateTime? @map("refunded_at")
  refundReason     String?   @map("refund_reason") @db.Text
  metadata         String?   @db.Text
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
  @@index([paymentSessionId])
  @@map("payments")
}

// ============================================
// EMAIL & AUDIT
// ============================================

model EmailTemplate {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique @db.VarChar(100)
  purpose     String?  @db.VarChar(50)
  category    String   @default("GENERAL") @db.VarChar(50)
  description String?  @db.VarChar(500)
  subject     String   @db.VarChar(200)
  htmlContent String   @map("html_content") @db.Text
  textContent String?  @map("text_content") @db.Text
  variables   String?  @db.Text
  isActive    Boolean  @default(false) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  version     Int      @default(1)
  createdBy   String?  @map("created_by") @db.VarChar(36)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  emailLogs EmailLog[]

  @@index([category, isActive])
  @@index([purpose, isDefault])
  @@map("email_templates")
}

model EmailLog {
  id            String    @id @default(uuid()) @db.VarChar(36)
  purpose       String    @db.VarChar(50)
  businessEvent String?   @map("business_event") @db.VarChar(50)
  orderId       String?   @map("order_id") @db.VarChar(36)
  triggeredBy   String?   @map("triggered_by") @db.VarChar(36)
  templateId    String?   @map("template_id") @db.VarChar(36)
  to            String    @db.VarChar(100)
  subject       String    @db.VarChar(200)
  htmlContent   String    @map("html_content") @db.Text
  status        String    @default("PENDING") @db.VarChar(20)
  provider      String?   @db.VarChar(50)
  providerId    String?   @map("provider_id") @db.VarChar(100)
  error         String?   @db.Text
  metadata      String?   @db.Text
  sentAt        DateTime? @map("sent_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  order    Order?         @relation(fields: [orderId], references: [id], onDelete: SetNull)
  template EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([to])
  @@index([status])
  @@index([orderId, purpose])
  @@index([businessEvent])
  @@map("email_logs")
}

model AuditLog {
  id        String   @id @default(uuid()) @db.VarChar(36)
  userId    String?  @map("user_id") @db.VarChar(36)
  userRole  String?  @map("user_role") @db.VarChar(20)
  action    String   @db.VarChar(50)
  entity    String   @db.VarChar(50)
  entityId  String?  @map("entity_id") @db.VarChar(36)
  oldValue  String?  @map("old_value") @db.Text
  newValue  String?  @map("new_value") @db.Text
  changes   String?  @db.Text
  metadata  String?  @db.Text
  ipAddress String?  @map("ip_address") @db.VarChar(50)
  userAgent String?  @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

model EventTimeline {
  id               String   @id @default(uuid()) @db.VarChar(36)
  eventId          String   @map("event_id") @db.VarChar(36)
  startTime        String   @map("start_time") @db.VarChar(10)
  endTime          String   @map("end_time") @db.VarChar(10)
  title            String   @db.VarChar(200)
  description      String?  @db.Text
  speakerName      String?  @map("speaker_name") @db.VarChar(100)
  speakerAvatarUrl String?  @map("speaker_avatar_url") @db.VarChar(500)
  type             String   @default("OTHER") @db.VarChar(20)
  orderIndex       Int      @default(0) @map("order_index")
  status           String   @default("DRAFT") @db.VarChar(20)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([eventId, status])
  @@index([orderIndex])
  @@map("event_timelines")
}

