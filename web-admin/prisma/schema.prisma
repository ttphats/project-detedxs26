// Prisma Schema for TEDx Ticketing Platform
// Optimized for serverless, high-concurrency ticket sales

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================

model Role {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique @db.VarChar(50) // SUPER_ADMIN, ADMIN, STAFF, USER
  description String?  @db.VarChar(255)
  permissions String?  @db.Text // JSON array of permissions
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("roles")
}

model User {
  id           String    @id @default(uuid()) @db.VarChar(36)
  email        String?   @unique @db.VarChar(100)
  username     String?   @unique @db.VarChar(50)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  fullName     String    @map("full_name") @db.VarChar(100)
  phoneNumber  String?   @map("phone_number") @db.VarChar(20)
  roleId       String    @map("role_id") @db.VarChar(36)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  role      Role       @relation(fields: [roleId], references: [id])
  orders    Order[]
  auditLogs AuditLog[]

  @@index([email])
  @@index([username])
  @@index([roleId])
  @@map("users")
}

// ============================================
// EVENTS
// ============================================

model Event {
  id             String    @id @default(uuid()) @db.VarChar(36)
  name           String    @db.VarChar(200)
  slug           String    @unique @db.VarChar(100)
  description    String?   @db.Text
  venue          String    @db.VarChar(200)
  eventDate      DateTime  @map("event_date")
  doorsOpenTime  DateTime  @map("doors_open_time")
  startTime      DateTime  @map("start_time")
  endTime        DateTime  @map("end_time")
  status         String    @default("DRAFT") @db.VarChar(20) // DRAFT, PUBLISHED, CANCELLED, COMPLETED
  maxCapacity    Int       @map("max_capacity")
  availableSeats Int       @map("available_seats")
  bannerImageUrl String?   @map("banner_image_url") @db.VarChar(500)
  thumbnailUrl   String?   @map("thumbnail_url") @db.VarChar(500)
  isPublished    Boolean   @default(false) @map("is_published")
  publishedAt    DateTime? @map("published_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  seatLayouts SeatLayout[]
  seats       Seat[]
  orders      Order[]

  @@index([slug])
  @@index([status])
  @@index([eventDate])
  @@map("events")
}

// ============================================
// SEAT MANAGEMENT
// ============================================

model SeatLayout {
  id         String   @id @default(uuid()) @db.VarChar(36)
  eventId    String   @map("event_id") @db.VarChar(36)
  name       String   @db.VarChar(100)
  layoutData String   @default("{}") @map("layout_data") @db.Text // JSON: seat map configuration
  totalSeats Int      @map("total_seats")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("seat_layouts")
}

model Seat {
  id         String  @id @default(uuid()) @db.VarChar(36)
  eventId    String  @map("event_id") @db.VarChar(36)
  seatNumber String  @map("seat_number") @db.VarChar(20)
  row        String  @db.VarChar(10)
  col        String  @db.VarChar(10)
  section    String  @db.VarChar(50)
  seatType   String  @map("seat_type") @db.VarChar(20) // VIP, REGULAR, STUDENT
  price      Decimal @db.Decimal(10, 2)
  status     String  @default("AVAILABLE") @db.VarChar(20) // AVAILABLE, LOCKED, SOLD, RESERVED
  positionX  Int?    @map("position_x")
  positionY  Int?    @map("position_y")
  isDisabled Boolean @default(false) @map("is_disabled")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  event      Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@unique([eventId, seatNumber])
  @@index([eventId, status])
  @@index([seatType])
  @@map("seats")
}

// ============================================
// ORDERS & PAYMENTS
// ============================================

model Order {
  id                 String    @id @default(uuid()) @db.VarChar(36)
  orderNumber        String    @unique @map("order_number") @db.VarChar(50)
  userId             String?   @map("user_id") @db.VarChar(36)
  eventId            String    @map("event_id") @db.VarChar(36)
  totalAmount        Decimal   @map("total_amount") @db.Decimal(10, 2)
  status             String    @default("PENDING") @db.VarChar(20) // PENDING, PAID, FAILED, EXPIRED, CANCELLED
  customerEmail      String    @map("customer_email") @db.VarChar(100)
  customerName       String    @map("customer_name") @db.VarChar(100)
  customerPhone      String?   @map("customer_phone") @db.VarChar(20)
  expiresAt          DateTime? @map("expires_at")
  paidAt             DateTime? @map("paid_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason") @db.Text
  emailSentAt        DateTime? @map("email_sent_at") // Track when confirmation email was sent
  qrCodeUrl          String?   @map("qr_code_url") @db.VarChar(500) // Store QR code URL

  // Ticketless authentication - access via token without login
  accessTokenHash    String?   @map("access_token_hash") @db.VarChar(128) // SHA-256 hash of access token

  // Check-in tracking
  checkedInAt        DateTime? @map("checked_in_at") // When ticket was checked in
  checkedInBy        String?   @map("checked_in_by") @db.VarChar(36) // Staff user ID who checked in

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  event      Event       @relation(fields: [eventId], references: [id])
  orderItems OrderItem[]
  payment    Payment?

  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([accessTokenHash])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(uuid()) @db.VarChar(36)
  orderId    String   @map("order_id") @db.VarChar(36)
  seatId     String   @map("seat_id") @db.VarChar(36)
  price      Decimal  @db.Decimal(10, 2)
  seatNumber String   @map("seat_number") @db.VarChar(20)
  seatType   String   @map("seat_type") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  seat  Seat  @relation(fields: [seatId], references: [id])

  @@index([orderId])
  @@index([seatId])
  @@map("order_items")
}

model Payment {
  id                String    @id @default(uuid()) @db.VarChar(36)
  orderId           String    @unique @map("order_id") @db.VarChar(36)
  paymentMethod     String    @map("payment_method") @db.VarChar(30) // BANK_TRANSFER, CREDIT_CARD, VNPAY, MOMO, ZALOPAY
  amount            Decimal   @db.Decimal(10, 2)
  status            String    @default("PENDING") @db.VarChar(20) // PENDING, COMPLETED, FAILED, REFUNDED
  transactionId     String?   @unique @map("transaction_id") @db.VarChar(100)
  paymentGateway    String?   @map("payment_gateway") @db.VarChar(50)
  paymentSessionId  String?   @unique @map("payment_session_id") @db.VarChar(100) // Stripe session, VNPay txnRef, etc.
  paymentProof      String?   @map("payment_proof") @db.VarChar(500) // URL to uploaded proof
  webhookReceived   Boolean   @default(false) @map("webhook_received")
  webhookProcessed  Boolean   @default(false) @map("webhook_processed")
  webhookData       String?   @map("webhook_data") @db.Text // JSON
  paidAt            DateTime? @map("paid_at")
  refundedAt        DateTime? @map("refunded_at")
  refundReason      String?   @map("refund_reason") @db.Text
  metadata          String?   @db.Text // JSON for additional payment data
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
  @@index([paymentSessionId])
  @@map("payments")
}

// ============================================
// EMAIL TEMPLATES
// ============================================

// Email purposes enum (stored as string in DB)
// Values: PAYMENT_PENDING, PAYMENT_CONFIRMED, PAYMENT_REJECTED,
//         TICKET_CONFIRMED, TICKET_CANCELLED, EVENT_REMINDER,
//         CHECKIN_CONFIRMATION, ADMIN_NOTIFICATION

model EmailTemplate {
  id          String   @id @default(uuid()) @db.VarChar(36)
  purpose     String   @db.VarChar(50) // PAYMENT_PENDING, PAYMENT_CONFIRMED, TICKET_CONFIRMED, etc.
  name        String   @db.VarChar(100)
  subject     String   @db.VarChar(200)
  htmlContent String   @map("html_content") @db.LongText
  textContent String?  @map("text_content") @db.Text
  variables   String?  @db.Text // JSON array of variable names
  isActive    Boolean  @default(false) @map("is_active")
  version     Int      @default(1)
  createdBy   String?  @map("created_by") @db.VarChar(36)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  emailLogs   EmailLog[]

  @@unique([purpose, isActive]) // Only one active template per purpose (enforced at app level)
  @@index([purpose])
  @@index([isActive])
  @@index([createdBy])
  @@map("email_templates")
}

model EmailLog {
  id            String    @id @default(uuid()) @db.VarChar(36)
  purpose       String    @db.VarChar(50) // Email purpose: PAYMENT_CONFIRMED, TICKET_CONFIRMED, etc.
  businessEvent String?   @map("business_event") @db.VarChar(50) // PAYMENT_CONFIRMED, ORDER_CANCELLED, etc.
  templateId    String?   @map("template_id") @db.VarChar(36)
  orderId       String?   @map("order_id") @db.VarChar(36) // Link to order for anti-spam check
  to            String    @db.VarChar(100)
  subject       String    @db.VarChar(200)
  htmlContent   String    @map("html_content") @db.LongText
  status        String    @default("PENDING") @db.VarChar(20) // PENDING, SENT, FAILED
  provider      String?   @db.VarChar(50) // resend, sendgrid, mock
  providerId    String?   @map("provider_id") @db.VarChar(100) // Email ID from provider
  triggeredBy   String?   @map("triggered_by") @db.VarChar(36) // Admin user ID who triggered send
  error         String?   @db.Text
  metadata      String?   @db.Text // JSON: additional context
  sentAt        DateTime? @map("sent_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  template      EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@unique([orderId, purpose]) // Anti-spam: only 1 email per purpose per order (except resend)
  @@index([purpose])
  @@index([businessEvent])
  @@index([templateId])
  @@index([orderId])
  @@index([to])
  @@index([status])
  @@index([triggeredBy])
  @@index([createdAt])
  @@map("email_logs")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id         String   @id @default(uuid()) @db.VarChar(36)
  userId     String?  @map("user_id") @db.VarChar(36)
  userRole   String?  @map("user_role") @db.VarChar(50) // SUPER_ADMIN, ADMIN, STAFF, USER
  action     String   @db.VarChar(50) // CREATE, UPDATE, DELETE, CONFIRM, REJECT, LOGIN, LOGOUT, etc.
  entity     String   @db.VarChar(50) // EVENT, PAYMENT, TICKET, SEAT, EMAIL, USER, SETTING
  entityId   String?  @map("entity_id") @db.VarChar(36)
  oldValue   String?  @map("old_value") @db.Text // JSON of old values
  newValue   String?  @map("new_value") @db.Text // JSON of new values
  changes    String?  @db.Text // JSON summary of changes (deprecated, use oldValue/newValue)
  ipAddress  String?  @map("ip_address") @db.VarChar(50)
  userAgent  String?  @map("user_agent") @db.Text
  metadata   String?  @db.Text // Additional context (JSON)
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userRole])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

